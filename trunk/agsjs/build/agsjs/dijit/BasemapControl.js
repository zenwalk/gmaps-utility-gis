/** built on 2011-12-07 */ 
dojo.provide("agsjs.dijit.BasemapControl");dojo.require("dijit._Widget");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.form.Slider");
dojo.declare("agsjs.dijit.BasemapControl",[dijit._Widget],{maps:null,basemaps:null,_selectedBase:null,constructor:function(a){a=a||{};if(!a.map)throw new Error("no map defined in params for TOC");dojo.mixin(this,a);this._init()},_init:function(){dojo.forEach(this.basemaps,function(a,b){if(a.selected)this._selectedBase=a;a._refs=[];a._bases=[];var c=false;dojo.forEach(a.layers,function(d,g){if(!d.id)d.id="basemap_"+b+"_"+g;d.visible=d.visible||false;if(d.isReference)a._refs.push(d);else{a._bases.push(d);
if(d.visible)c=true}},this);if(!c)a._bases[0].visible=true},this);if(!this._selectedBase){this._selectedBase=this.basemaps[0];this._selectedBase.selected=true}this.map.layerIds.length==0&&this._selectedBase&&this._selectBase(this._selectedBase,true);this.loaded=true;this.onLoad()},postCreate:function(){this._createUI()},_selectBase:function(a,b){if(!(!b&&a==this._selectedBase)){this._removeBaseLayers();this._selectedBase=a;this._addBaseLayers(a._refs);this._addBaseLayers(a._bases)}},_addBaseLayers:function(a){var b=
this._selectedBase,c;dojo.forEach(a,function(d){c=d._layer;if(!c){c=this._createLayer(d);d.layer=c}if(c)if(d.isReference){c._isReference=true;this.map.addLayer(c,this.map.layerIds.length)}else{c._isBaseMap=true;if(c==b._googleLayer||c==b._bingLayer){if(!c._addedToMap){this.map.addLayer(c,0);c._addedToMap=true}if(c==b._googleLayer){c.setMapTypeId(d._subtype);if(d.visible)d.styles?c.setMapStyles(d.styles):c.setMapStyles(null)}c==b._bingLayer&&c.setMapStyle(d._subtype)}else this.map.addLayer(c,0)}},
this)},_removeBaseLayers:function(){var a=this._selectedBase,b=[];dojo.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);if(c._isBaseMap||c._isReference)b.push(c)},this);b.length>0&&dojo.forEach(b,function(c){try{if(c==a._googleLayer||c==a._bingLayer)c._addedToMap=false;this.map.removeLayer(c)}catch(d){console&&console.error(d)}},this)},_createLayer:function(a){var b=null;b=a.type||"ArcGISTiled";if(b.indexOf("GoogleMaps")==0)b=this._createGoogleLayer(a);else if(b.indexOf("BingMaps")==0)b=
this._createBingLayer(a);else switch(b){case "OpenStreetMap":b=new esri.layers.OpenStreetMapLayer(a);break;case "ArcGISTiled":b=new esri.layers.ArcGISTiledMapServiceLayer(a.url,a);break;default:b=new (dojo.getObject(b))(a.url,a)}return b},_createGoogleLayer:function(a){var b=this._selectedBase;if(!(agsjs&&agsjs.layers&&agsjs.layers.GoogleMapsLayer))throw"use dojo.require('agsjs.layers.GoogleMapsLayer') before using this widget";var c={GoogleMapsRoadMap:agsjs.layers.GoogleMapsLayer.MAP_TYPE_ROADMAP,
GoogleMapsSatellite:agsjs.layers.GoogleMapsLayer.MAP_TYPE_SATELLITE,GoogleMapsHybrid:agsjs.layers.GoogleMapsLayer.MAP_TYPE_HYBRID,GoogleMapsTerrain:agsjs.layers.GoogleMapsLayer.MAP_TYPE_TERRAIN}[a.type];a._subtype=c;if(b._googleLayer){if(a.visible){b._googleLayer.setMapTypeId(c);b._googleLayer.show()}}else{b._googleLayer=new agsjs.layers.GoogleMapsLayer(dojo.mixin({mapOptions:{mapTypeId:c}},a));dojo.connect(b._googleLayer,"onStreetViewVisibilityChange",this,function(d){d?esri.hide(this.domNode):esri.show(this.domNode)});
this.onGoogleMapsLayerCreate(b._googleLayer)}return b._googleLayer},onGoogleMapsLayerCreate:function(){},_createBingLayer:function(a){var b=this._selectedBase,c={BingMapsRoad:esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD,BingMapsAerial:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL,BingMapsHybrid:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS}[a.type];a._subtype=c;if(b._bingLayer){if(a.visible){b._bingLayer.setMapStyle(c);b._bingLayer.show()}}else{if(a.bingMapsKey)this._bingMapsKey=
a.bingMapsKey;else a.bingMapsKey=this._bingMapsKey;b._bingLayer=new esri.virtualearth.VETiledLayer(dojo.mixin({mapStyle:c},a));this.onBingMapsLayerCreate(this._bingLayer)}return b._bingLayer},onBingMapsLayerCreate:function(){},_switchLayer:function(a,b,c){var d=this._selectedBase,g=false;dojo.forEach(d._refs,function(e){if(e.name==a){e.visible=!e.visible;e.layer&&e.layer.setVisibility(e.visible);g=true}},this);if(!g){dojo.forEach(d._bases,function(e){if(e.name!=a&&e.name!=b){e.visible=false;e.layer&&
e.layer.hide()}});dojo.forEach(d._bases,function(e){if(e.name==a||e.name==b){var h=e.layer;if(h==d._googleLayer){h.setMapTypeId(e._subtype);e.styles?h.setMapStyles(e.styles):h.setMapStyles(null)}else h==d._bingLayer&&h.setMapStyle(e._subtype);if(!h.visible){h.show();e.visible=true}if(e.name!=a)c=1-c;if(c>0.9)c=1;c<0.1?h.hide():h.setOpacity(c)}},this)}},onLoad:function(){},_createBasemapUI:function(a){var b=new dijit.layout.ContentPane({title:a.title,selected:a.selected}),c={};dojo.forEach(a._refs,
function(f){if(!c[f.name]){var i;if(dijit.form&&dijit.form.CheckBox){i=new dijit.form.CheckBox({value:f.name,checked:f.visible});i.placeAt(b.domNode)}else i=dojo.create("input",{type:"checkbox",value:f.name},b.domNode);i.checked=f.visible;b.domNode.appendChild(dojo.doc.createTextNode(f.name));c[f.name]=i}});a._refs.length>0&&dojo.create("br",null,b.domNode);if(a.slider!=undefined){for(var d=a._bases.length,g=d-1,e=g;e>=0;e--)if(a._bases[e].visible){g=e;break}g=dojo.mixin({showButtons:false,style:"width:95%; margin-top:6px",
maximum:d-1,value:g},a.slider);var h=[];dojo.forEach(a._bases,function(f){h.push(f.name)});var j={labels:h,container:"bottomDecoration",count:d,style:"height:0.5em;font-size:75%"};e=dojo.create("div",{},b.domNode);d=new dijit.form.HorizontalRule(j,dojo.create("div",{style:{height:"2px"}},e));j=new dijit.form.HorizontalRuleLabels(j,dojo.create("div",{style:{height:"2px"}},e));g=new dijit.form.HorizontalSlider(g,e);g.startup();d.startup();j.startup();dojo.connect(g,"onChange",this,this._onSliderChanged)}else{c=
{};dojo.forEach(a._bases,function(f){if(!c[f.name]){var i=null;if(dijit.form&&dijit.form.RadioButton){i=new dijit.form.RadioButton({name:a.title,value:f.name,checked:f.visible});i.placeAt(b.domNode)}else{i=dojo.create("input",{type:"radio",name:a.title,value:f.name},b.domNode);i.checked=f.visible}b.domNode.appendChild(dojo.doc.createTextNode(f.name));c[f.name]=i}})}dojo.connect(b,"onClick",this,this._onTabClicked);return b},_createUI:function(){if(this.basemaps.length==1&&this.noTabs){var a=this._createBasemapUI(this.basemaps[0]);
dojo.addClass(a.domNode,"dijitTabPaneWrapper");a.domNode.style.borderWidth="1px";a.domNode.style.borderStyle="solid";a.placeAt(this.domNode);a.startup()}else{var b=new dijit.layout.TabContainer({doLayout:false});this._onTabChangeHandle=dojo.connect(b,"selectChild",this,this._onTabChangeHandler);dojo.forEach(this.basemaps,function(c){c=this._createBasemapUI(c);b.addChild(c)},this);b.placeAt(this.domNode);b.startup()}dojo.addClass(this.domNode,"agsBasemapControl")},_onTabChangeHandler:function(a){dojo.every(this.basemaps,
function(b){if(b.title==a.title){this._selectBase(b);return false}return true},this)},_onTabClicked:function(a){a=a.target;if(a.tagName=="INPUT"){var b=dijit.getEnclosingWidget(a);b&&(b.declaredClass=="dijit.form.CheckBox"||b.declaredClass=="dijit.form.RadioButton")?this._switchLayer(b.value):this._switchLayer(a.value)}},_onSliderChanged:function(a){var b=this._selectedBase._bases,c=Math.floor(a);this._switchLayer(b[c].name,b[Math.min(b.length-1,c+1)].name,1-(a-c))},destroy:function(){dojo.disconnect(this._onTabChangeHandle)}});
