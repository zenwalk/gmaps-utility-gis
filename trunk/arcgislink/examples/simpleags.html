<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <title>Simple AGS</title>
        <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript">
        </script>
        <script type="text/javascript">
            document.write('<script type="text/javascript" src="../src/arcgislink' + (document.location.search.indexOf('packed') > -1 ? '_packed' : '') + '.js"><' + '/script>');
        </script>
        <script type="text/javascript">
            var map, ov, iw, marker;
            function init() {
              var myOptions = {
                zoom: 4,
                center: new google.maps.LatLng(40, -100),
                size: new google.maps.Size(600, 400),// needed for get('size') to work for now
                mapTypeId: google.maps.MapTypeId.ROADMAP
              }
              map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
              loadMapService();
            }
            
            /**
             * Create a map overlay and add to map
             */
            function loadMapService() {
              var url = 'http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer';
              ov = new ArcGISMapOverlay(url, {
                opacity: 0.8
              });
              google.maps.event.addListener(ov, 'load', function() {
                ov.addToMap(map);
                refreshTOC();
                google.maps.event.addListener(map, 'click', doIdentify);
              });
            }
            
            /**
             * Create layer list.
             */
            function refreshTOC() {
              var service = ov.getMapService();
              var toc = '';
              var layers = service.getLayers();
              for (var i = 0; i < layers.length; i++) {
                toc += '<input type="checkbox" id="layer' + layers[i].id + '"';
                if (layers[i].visible) 
                  toc += ' checked="checked"';
                toc += ' onclick="setLayerVisibility()">' + layers[i].name + '<br/>';
              }
              document.getElementById('toc').innerHTML = toc;
            }
            
            /**
             * Check the visibility of layers and refresh map
             */
            function setLayerVisibility() {
              var service = ov.getMapService();
              var layers = service.getLayers();
              for (var i = 0; i < layers.length; i++) {
                var el = document.getElementById('layer' + layers[i].id);
                layers[i].visible = (el.checked === true);
              }
              ov.refresh();
            }
            
            /**
             * Handler function for map click event
             * @param {google.maps.MouseEvent} evt
             */
            function doIdentify(evt) {
              var opts = {};
              if (evt && evt.latLng) {
                var ll = evt.latLng;
                var bnds = map.get_bounds();
                var sw = bnds.getSouthWest();
                var ne = bnds.getNorthEast();
                var size = map.get('size');
                var service = ov.getMapService();
                var params = {
                  geometry: '' + ll.lng() + ',' + ll.lat(),
                  geometryType: 'esriGeometryPoint',
                  sr: 4326,//use lat lng for demo simplicity 
                  layers: opts.layers || 'top',
                  tolerance: 5,//pixel
                  mapExtent: '' + sw.lng() + ',' + sw.lat() + ',' + ne.lng() + ',' + ne.lat(),
                  imageDisplay: '' + size.width + ',' + size.height + ',' + 96, //dpi
                  returnGeometry: false
                };
                service.identify(params, function(json) {
                  if (json) {
                    if (json.error) {
                      alert(json.error.message + '\n' + json.error.details.join('\n'));
                    } else if (json.results) {
                      processIdentifyResults(json, ll);
                    }
                    
                  }
                });
                
              }
            }
            
            function processIdentifyResults(json, ll) {
              var html = '';
              if (json.results) {
                for (var i = 0, c = json.results.length; i < c; i++) {
                  var r = json.results[i];
                  if (i > 0) {
                    html += '<hr/>';
                  }
                  html += '<div><table>';
                  html += '<tr><td>' + r.layerName + '</td></tr>';
                  html += '<tr><td><table>';
                  var a = r.attributes;
                  for (var x in a) {
                    if (a.hasOwnProperty(x)) {
                      html += '<tr>';
                      html += '<td>' + x + '</td>';
                      var val = a[x];
                      val = (val === null || typeof val === 'undefined') ? '' : '' + val;
                      html += '<td>' + val + '</td></tr>';
                    }
                  }
                  html += '</table></td></tr></table></div>';
                  
                }
              }
              html = '<div style="height:100px;overflow:auto">' + html + '</div>';
              if (iw == null) {
                iw = new google.maps.InfoWindow({
                  content: html,
                  position: ll
                });
                marker = new google.maps.Marker({
                  position: ll, 
                  map: map
                })
                iw.open(map, marker);
              } else {
                iw.set_content(html);
                iw.set_position(ll);
                marker.set_position(ll);
                iw.open(map, marker);
              }
              
              
            }
        </script>
    </head>
    <body onload="init()">
        <a href='../docs/examples.html'>More examples</a>
        | Use<a href='?packed'>Packed </a>
        | <a href='?'>Unpacked</a>
        Version of the script.
        <br/>
        <br/>
        Use Check box to turn on/off layers in a dynamic map service.
        <table>
            <tr>
                <td valign="top">
                    <div id="toc" style="width:130px;border:1px solid gray">
                    </div>
                    <br/>
                    <div id="info" style="width:130px; border:1px solid gray">
                    </div>
                </td>
                <td>
                    <div id="map_canvas" style="width:600px; height:400px; border:1px solid #000;">
                    </div>
                </td>
            </tr>
        </table>
    </body>
</html>
