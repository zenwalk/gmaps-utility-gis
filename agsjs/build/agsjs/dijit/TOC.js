/*built on 2012-07-18*/ 
dojo.provide("agsjs.dijit.TOC");dojo.require("dojo.fx");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Slider");(function(){var a=dojo.create("link",{type:"text/css",rel:"stylesheet",href:dojo.moduleUrl("agsjs.dijit","css/TOC.css")});dojo.doc.getElementsByTagName("head")[0].appendChild(a)}());dojo.declare("agsjs.dijit._TOCNode",[dijit._Widget,dijit._Templated],{templateString:'<div class="agsjsTOCNode"><div data-dojo-attach-point="rowNode" data-dojo-attach-event="onclick:_onClick"><span data-dojo-attach-point="contentNode" class="agsjsTOCContent"><span data-dojo-attach-point="checkContainerNode"></span><img src="${_blankGif}" alt="" data-dojo-attach-point="iconNode" /><span data-dojo-attach-point="labelNode"></span></span></div><div data-dojo-attach-point="containerNode" style="display: none;"> </div></div>',rootLayer:null,layer:null,legend:null,rootLayerTOC:null,data:null,_childTOCNodes:[],constructor:function(b,a){dojo.mixin(this,b)},postCreate:function(){dojo.style(this.rowNode,"paddingLeft",""+this.rootLayerTOC.toc.indentSize*this.rootLayerTOC._currentIndent+"px");this.data=this.legend||this.layer||this.rootLayer;this.blank=this.iconNode.src;if(this.legend){this._createLegendNode(this.legend)}else{if(this.layer){this._createLayerNode(this.layer)}else{if(this.rootLayer){this._createRootLayerNode(this.rootLayer)}}}if(this.containerNode){this.toggler=new dojo.fx.Toggler({node:this.containerNode,showFunc:dojo.fx.wipeIn,hideFunc:dojo.fx.wipeOut})}if(!this._noCheckNode){var b;if(dijit.form&&dijit.form.CheckBox){b=new dijit.form.CheckBox({checked:this.data.visible});b.placeAt(this.checkContainerNode);b.startup()}else{b=dojo.create("input",{type:"checkbox",checked:this.data.visible},this.checkContainerNode)}this.checkNode=b}var a=this.data.visible;if(this.data._subLayerInfos){var c=true;dojo.every(this.data._subLayerInfos,function(d){if(d.visible){c=false;return false}return true});if(c){a=false}}if(this.data.collapsed){a=false}if(this.iconNode&&this.iconNode.src==this.blank){dojo.addClass(this.iconNode,"dijitTreeExpando");dojo.addClass(this.iconNode,a?"dijitTreeExpandoOpened":"dijitTreeExpandoClosed")}if(this.containerNode){dojo.style(this.containerNode,"display",a?"block":"none")}if(this.rootLayerTOC.toc.style=="standard"&&this.iconNode&&this.checkNode){dojo.place(this.iconNode,this.checkNode.domNode||this.checkNode,"before")}},_createRootLayerNode:function(a){dojo.addClass(this.rowNode,"agsjsTOCRootLayer");dojo.addClass(this.labelNode,"agsjsTOCRootLayerLabel");var b=this.rootLayerTOC.info.title;if(b===""){esri.hide(this.rowNode);a.show();this.rootLayerTOC._currentIndent--}a.collapsed=this.rootLayerTOC.info.collapsed;if(this.rootLayerTOC.info.slider){this.sliderNode=dojo.create("div",{"class":"agsjsTOCSlider"},this.rowNode,"last");this.slider=new dijit.form.HorizontalSlider({showButtons:false,value:a.opacity*100,intermediateChanges:true,tooltip:"adjust transparency",onChange:function(c){a.setOpacity(c/100)},layoutAlign:"right"});this.slider.placeAt(this.sliderNode);dojo.connect(a,"onOpacityChange",this,function(d){var c=this.slider;this.slider.setValue(d*100)})}if(!this.rootLayerTOC.info.noLegend){this._createChildrenNodes(a._tocInfos,"layer")}else{dojo.style(this.iconNode,"visibility","hidden")}this.labelNode.innerHTML=b;dojo.attr(this.rowNode,"title",b)},_createLayerNode:function(b){this.labelNode.innerHTML=b.name;if(b._subLayerInfos){dojo.addClass(this.rowNode,"agsjsTOCGroupLayer");dojo.addClass(this.labelNode,"agsjsTOCGroupLayerLabel");if(this.rootLayerTOC.info.showGroupCount){this.labelNode.innerHTML=b.name+" ("+b._subLayerInfos.length+")"}this._createChildrenNodes(b._subLayerInfos,"layer")}else{dojo.addClass(this.rowNode,"agsjsTOCLayer");dojo.addClass(this.labelNode,"agsjsTOCLayerLabel");if(this.rootLayer.tileInfo){this._noCheckNode=true}if(b.renderer&&!this.rootLayerTOC.info.noLegend&&this.rootLayerTOC.info.mode!="legend"){if(this.rootLayerTOC.toc.style=="inline"&&b.renderer.symbol){this._setIconNode(b.renderer,this.iconNode,this);dojo.destroy(this.containerNode);this.containerNode=null}else{if(b.renderer instanceof esri.renderer.SimpleRenderer){this._createChildrenNodes([b.renderer],"legend")}else{var a=b.renderer.infos;if(b.renderer.defaultSymbol){a=[{symbol:b.renderer.defaultSymbol,label:b.renderer.defaultLabel,isDefault:true,url:b.renderer.url,imageData:b.renderer.imageData,value:"*"}].concat(a)}this._createChildrenNodes(a,"legend")}}}else{if(b.legends&&!this.rootLayerTOC.info.noLegend){if(this.rootLayerTOC.toc.style=="inline"&&b.legends.length==1){this.iconNode.src=this._getLegendIconUrl(b.legends[0]);dojo.destroy(this.containerNode);this.containerNode=null}else{this._createChildrenNodes(b.legends,"legend")}}else{dojo.destroy(this.iconNode);this.iconNode=null;dojo.destroy(this.containerNode);this.containerNode=null}}}},_createLegendNode:function(a){a.visible=false;if(this.layer&&this.layer.definitionExpression){if(this.layer.renderer&&this.layer.renderer instanceof esri.renderer.UniqueValueRenderer&&!this.layer.renderer.attributeField2){if(!a.isDefault&&this.rootLayerTOC.toc.style=="inline"&&this.rootLayerTOC.info.mode!="legend"){a.visible=true}}}if(!a.visible){this._noCheckNode=true}dojo.destroy(this.containerNode);dojo.addClass(this.labelNode,"agsjsTOCLegendLabel");this._setIconNode(a,this.iconNode,this);this.labelNode.appendChild(document.createTextNode(a.label))},_setIconNode:function(d,c,b){var e=this._getLegendIconUrl(d);if(!e||this.rootLayerTOC.info.mode=="layers"){if(d.symbol){var a=this._createSymbol(d.symbol);dojo.place(a,c,"replace");b.iconNode=a}}else{c.src=e;if(d.symbol&&d.symbol.width&&d.symbol.height){}}},_createSymbol:function(f){var a=this.rootLayerTOC.toc.swatchSize[0],d=this.rootLayerTOC.toc.swatchSize[1];if(f.width&&f.height){a=f.width;d=f.height}var e=dojo.create("span",{style:"width:"+a+";height:"+d});var g=dojox.gfx.createSurface(e,a,d);var c=esri.symbol.getShapeDescriptors(f);if(c){var b=g.createShape(c.defaultShape).setFill(c.fill).setStroke(c.stroke);b.applyTransform({dx:a/2,dy:d/2})}return e},_getLegendIconUrl:function(a){var b=a.url;if(b!=null&&b.indexOf("data")==-1){if(!dojo.isIE&&a.imageData&&a.imageData.length>0){b="data:image/png;base64,"+a.imageData}else{if(b.indexOf("http")!==0){b=this.rootLayer.url+"/"+this.layer.id+"/images/"+b}}}return b},_createChildrenNodes:function(a,d){this.rootLayerTOC._currentIndent++;var j=[];for(var b=0,h=a.length;b<h;b++){var f=a[b];var g={rootLayerTOC:this.rootLayerTOC,rootLayer:this.rootLayer,layer:this.layer,legend:this.legend};g[d]=f;g.data=f;var e=new agsjs.dijit._TOCNode(g);e.placeAt(this.containerNode);j.push(e)}this._childTOCNodes=j;this.rootLayerTOC._currentIndent--},_toggleContainer:function(a){if(dojo.hasClass(this.iconNode,"dijitTreeExpandoClosed")||dojo.hasClass(this.iconNode,"dijitTreeExpandoOpened")){if(a){dojo.removeClass(this.iconNode,"dijitTreeExpandoClosed");dojo.addClass(this.iconNode,"dijitTreeExpandoOpened")}else{if(a===false){dojo.removeClass(this.iconNode,"dijitTreeExpandoOpened");dojo.addClass(this.iconNode,"dijitTreeExpandoClosed")}else{dojo.toggleClass(this.iconNode,"dijitTreeExpandoClosed");dojo.toggleClass(this.iconNode,"dijitTreeExpandoOpened")}}if(this.toggler){if(dojo.hasClass(this.iconNode,"dijitTreeExpandoOpened")){this.toggler.show()}else{this.toggler.hide()}}}},_adjustToState:function(){if(this.checkNode){var b=this.legend?this.legend.visible:this.layer?this.layer.visible:this.rootLayer?this.rootLayer.visible:false;if(this.checkNode.set){this.checkNode.set("checked",b)}else{this.checkNode.checked=b}}if(this.layer){var c=esri.geometry.getScale(this.rootLayerTOC.toc.map);var a=(this.layer.maxScale!=0&&c<this.layer.maxScale)||(this.layer.minScale!=0&&c>this.layer.minScale);if(a){dojo.addClass(this.domNode,"agsjsTOCOutOfScale")}else{dojo.removeClass(this.domNode,"agsjsTOCOutOfScale")}if(this.checkNode){if(this.checkNode.set){this.checkNode.set("disabled",a)}else{this.checkNode.disabled=a}}}if(this._childTOCNodes.length>0){dojo.forEach(this._childTOCNodes,function(d){d._adjustToState()})}},_onClick:function(a){var b=a.target;if(b==this.checkNode||dijit.getEnclosingWidget(b)==this.checkNode){if(this.legend){var e=this.layer.renderer;this.legend.visible=this.checkNode.checked;var d=[];if(e instanceof esri.renderer.UniqueValueRenderer){var c="";if(this.layer.fields){dojo.forEach(this.layer.fields,function(f){if(f.name.toLowerCase()==e.attributeField.toLowerCase()){switch(f.type){case"esriFieldTypeString":c="'"}}})}dojo.forEach(e.infos,function(f){if(f.visible){d.push(c+f.value+c)}},this);if(d.length==e.infos.length){this.layer._definitionExpression=""}else{if(d.length==0){this.layer.visible=false}else{this.layer.visible=true;this.layer._definitionExpression=e.attributeField+" IN ("+d.join(",")+")"}}}this.rootLayer.setVisibleLayers(this._getVisibleLayers(),true);this.rootLayer.setLayerDefinitions(this._getLayerDefs(),true);this.rootLayerTOC._refreshLayer()}else{if(this.layer){this.layer.visible=this.checkNode&&this.checkNode.checked;if(this.layer._parentLayerInfo&&!this.layer._parentLayerInfo.visible){this.layer._parentLayerInfo.visible=true}if(this.layer.visible&&!this.rootLayer.visible){this.rootLayer.show()}if(this.layer._subLayerInfos){dojo.forEach(this.layer._subLayerInfos,function(f){f.visible=this.layer.visible},this)}if(this.layer.renderer){dojo.forEach(this.layer.renderer.infos,function(f){f.visible=this.layer.visible},this);this.layer._definitionExpression=""}this.rootLayer.setLayerDefinitions(this._getLayerDefs(),true);this.rootLayer.setVisibleLayers(this._getVisibleLayers(),true);this.rootLayerTOC._refreshLayer()}else{if(this.rootLayer){this.rootLayer.setVisibility(this.checkNode&&this.checkNode.checked)}}}if(this.rootLayerTOC.toc.style=="inline"){this._toggleContainer(this.checkNode&&this.checkNode.checked)}this.rootLayerTOC._adjustToState()}else{if(b==this.iconNode){this._toggleContainer()}}},_getVisibleLayers:function(){var a=[];dojo.forEach(this.rootLayer.layerInfos,function(b){if(b.subLayerIds){return}else{if(b.visible){a.push(b.id)}}});if(a.length===0){a.push(-1)}else{if(!this.rootLayer.visible){this.rootLayer.show()}}return a},_getLayerDefs:function(){var a=[];dojo.forEach(this.rootLayer.layerInfos,function(c,b){if(c._definitionExpression){a[b]=c._definitionExpression}});return a}});dojo.declare("agsjs.dijit._RootLayerTOC",[dijit._Widget],{_currentIndent:0,rootLayer:null,toc:null,constructor:function(b,a){this.rootLayer=b.rootLayer;this.toc=b.toc;this.info=b.info||{}},postCreate:function(){this._getLayerInfos()},_getLayerInfos:function(){if((this.rootLayer instanceof (esri.layers.ArcGISDynamicMapServiceLayer)||this.rootLayer instanceof (esri.layers.ArcGISTiledMapServiceLayer))){if(this.info.title===undefined){var b=this.rootLayer.url.toLowerCase().indexOf("/rest/services/");var a=this.rootLayer.url.toLowerCase().indexOf("/mapserver",b);this.info.title=this.rootLayer.url.substring(b+15,a)}}else{this.info.noLayers=true}if(!this.rootLayer.url||this.info.noLegend||this.info.noLayers){this._createRootLayerTOC()}else{if(this.info.mode=="legend"){this._getLegendInfo()}else{if(this.info.mode=="layers"){this._getLayersInfo()}else{this._getLayersInfo();this._getLegendInfo()}}}},_getLegendInfo:function(){var a="";if(this.rootLayer.version>=10.01){a=this.rootLayer.url+"/legend"}else{a="http://www.arcgis.com/sharing/tools/legend";var b=this.rootLayer.url.toLowerCase().indexOf("/rest/");var d=this.rootLayer.url.substring(0,b)+this.rootLayer.url.substring(b+5);a=a+"?soapUrl="+escape(d)}var c=esri.request({url:a,content:{f:"json"},callbackParamName:"callback",handleAs:"json",load:dojo.hitch(this,this._processLegendInfo),error:dojo.hitch(this,this._createRootLayerTOC)})},_getLayersInfo:function(){var a=this.rootLayer.url+"/layers";var b=esri.request({url:a,content:{f:"json"},callbackParamName:"callback",handleAs:"json",load:dojo.hitch(this,this._processLayersInfo),error:dojo.hitch(this,this._createRootLayerTOC)})},_processLegendError:function(a){console.log(a);this._createRootLayerTOC()},_processLegendInfo:function(a){this.rootLayer._legendResponse=a;if(this.info.mode=="legend"||this.rootLayer._layersResponse){this._createRootLayerTOC()}},_processLayersInfo:function(a){this.rootLayer._layersResponse=a;if(this.info.mode=="layers"||this.rootLayer._legendResponse){this._createRootLayerTOC()}},_createRootLayerTOC:function(){var b=this.rootLayer;if(!b._tocInfos){var c={};dojo.forEach(b.layerInfos,function(d){c[""+d.id]=d;d.visible=d.defaultVisibility});if(b._layersResponse){dojo.forEach(b._layersResponse.layers,function(d){var e=c[""+d.id];if(e){dojo.mixin(e,d);e.definitionExpression=d.definitionExpression;if(d.drawingInfo&&d.drawingInfo.renderer){e.renderer=esri.renderer.fromJson(d.drawingInfo.renderer)}}})}if(b._legendResponse){dojo.forEach(b._legendResponse.layers,function(e){var f=c[""+e.layerId];if(f&&e.legend){f.legends=e.legend;if(f.renderer){if(f.renderer.infos){var d={};dojo.forEach(e.legend,function(g){d[g.label]=g});if(f.renderer.defaultSymbol){dojo.mixin(f.renderer,e.legend[0])}dojo.forEach(f.renderer.infos,function(j,g){var h=d[j.label];if(h){dojo.mixin(j,h)}})}else{dojo.mixin(f.renderer,e.legend[0])}}}})}dojo.forEach(b.layerInfos,function(e){if(e.subLayerIds){var d=[];dojo.forEach(e.subLayerIds,function(g,f){d[f]=c[g];d[f]._parentLayerInfo=e});e._subLayerInfos=d}});var a=[];dojo.forEach(b.layerInfos,function(d){if(d.parentLayerId==-1){a.push(d)}});b._tocInfos=a}this._rootLayerNode=new agsjs.dijit._TOCNode({rootLayerTOC:this,rootLayer:b});this._rootLayerNode.placeAt(this.domNode);this._visHandler=dojo.connect(b,"onVisibilityChange",this,"_adjustToState");this._visLayerHandler=dojo.connect(b,"setVisibleLayers",this,"_adjustToState");this._adjustToState()},_refreshLayer:function(){var a=this.rootLayer;var b=this.toc.refreshDelay;if(this._refreshTimer){window.clearTimeout(this._refreshTimer);this._refreshTimer=null}this._refreshTimer=window.setTimeout(function(){a.setVisibleLayers(a.visibleLayers)},500)},_adjustToState:function(){this._rootLayerNode._adjustToState()},destroy:function(){dojo.disconnect(this._visHandler);dojo.disconnect(this._visLayerHandler);dojo.disconnect(this._maptypeIdHandler)}});dojo.declare("agsjs.dijit.TOC",[dijit._Widget],{indentSize:18,swatchSize:[30,30],refreshDelay:500,style:"inline",layerInfos:null,slider:false,constructor:function(d,c){d=d||{};if(!d.map){throw new Error("no map defined in params for TOC")}dojo.mixin(this,d);this._rootLayerTOCs=[];if(!this.layerInfos){this.layerInfos=[];for(var b=this.map.layerIds.length-1;b>=0;b--){var a=this.map.getLayer(this.map.layerIds[b]);if(!a._isBaseMap&&!a._isReference){this.layerInfos.push({layer:a})}}dojo.connect(this.map,"onLayerAdd",this,function(e){this.layerInfos.push({layer:e});this.refresh()});dojo.connect(this.map,"onLayerRemove",this,function(f){for(var e=0;e<this.layerInfos.length;e++){if(this.layerInfos[e]==f){this.layerInfos.splice(e,1);break}}this.refresh()})}},postCreate:function(){var a=[];dojo.forEach(this.layerInfos,function(c){if(!c.layer){c.layer=this._createRootLayer(c);a.push(c.layer)}},this);if(a.length==0){this._createTOC()}else{var b=dojo.connect(this.map,"onLayersAddResult",this,function(c){dojo.disconnect(b);this._createTOC()});this.map.addLayers(a)}},_createRootLayer:function(b){var a=null;var c=b.type||"ArcGISDynamic";switch(c){case"ArcGISDynamic":a=new esri.layers.ArcGISDynamicMapServiceLayer(b.url,b);break}return a},_createTOC:function(){dojo.empty(this.domNode);for(var b=0,e=this.layerInfos.length;b<e;b++){var a=this.layerInfos[b].layer;var d=new agsjs.dijit._RootLayerTOC({rootLayer:a,info:this.layerInfos[b],toc:this});this._rootLayerTOCs.push(d);d.placeAt(this.domNode)}if(!this._zoomHandler){this._zoomHandler=dojo.connect(this.map,"onZoomEnd",this,"_adjustToState")}},_adjustToState:function(){dojo.forEach(this._rootLayerTOCs,function(a){a._adjustToState()})},refresh:function(){this._createTOC()},destroy:function(){dojo.disconnect(this._zoomHandler);this._zoomHandler=null}});